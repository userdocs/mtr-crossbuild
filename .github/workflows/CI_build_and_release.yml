name: matrix mtr multiarch build and release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        name: [mtr]
        docker_id: [userdocs]
        docker_repo: [mcm]
        docker_tag:
          [
            aarch64-linux-musl,
            aarch64_be-linux-musl,
            arm-linux-musleabi,
            arm-linux-musleabihf,
            armeb-linux-musleabi,
            armeb-linux-musleabihf,
            armel-linux-musleabi,
            armel-linux-musleabihf,
            armv5l-linux-musleabi,
            armv5l-linux-musleabihf,
            armv6-linux-musleabi,
            armv6-linux-musleabihf,
            armv7l-linux-musleabihf,
            armv7m-linux-musleabi,
            armv7r-linux-musleabihf,
            i486-linux-musl,
            i686-linux-musl,
            m68k-linux-musl,
            microblaze-linux-musl,
            microblazeel-linux-musl,
            mips-linux-musl,
            mips-linux-muslsf,
            mips-linux-musln32sf,
            mips64-linux-musl,
            mips64-linux-musln32,
            mips64-linux-musln32sf,
            mips64el-linux-musl,
            mips64el-linux-musln32,
            mips64el-linux-musln32sf,
            mipsel-linux-musl,
            mipsel-linux-musln32,
            mipsel-linux-musln32sf,
            mipsel-linux-muslsf,
            or1k-linux-musl,
            powerpc-linux-musl,
            powerpc-linux-muslsf,
            powerpc64-linux-musl,
            powerpc64le-linux-musl,
            powerpcle-linux-musl,
            powerpcle-linux-muslsf,
            riscv32-linux-musl,
            riscv64-linux-musl,
            s390x-linux-musl,
            sh2-linux-musl,
            sh2-linux-muslfdpic,
            sh2eb-linux-musl,
            sh2eb-linux-muslfdpic,
            sh4-linux-musl,
            sh4eb-linux-musl,
            x86_64-linux-musl,
            x86_64-linux-muslx32,
          ]

    name: ${{ matrix.name }} ${{ matrix.docker_tag }}

    env:
      prerelease: false

    steps:
      - uses: actions/checkout@v2.4.0

      - name: Host - update
        run: sudo apt-get update

      - name: Host - upgrade
        run: sudo apt-get -y upgrade

      - name: Host - Install host qemu-static
        run: sudo apt-get install -y qemu binfmt-support qemu-user-static curl

      - name: Host - Docker multiarch bootstrap
        run: sudo docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Host - Create Docker template env file
        run: echo "PATH=/root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" > env.custom

      - name: Host - Create docker multiarch ${{ matrix.arch }} container
        run: docker run --name multiarch -it -d --env-file env.custom -w /root -v ${{ github.workspace }}:/root ${{ matrix.docker_id }}/${{ matrix.docker_repo }}:${{ matrix.docker_tag }}

      - name: Docker - apk install build deps
        run: |
          docker exec --env-file env.custom -w /root multiarch apk add autoconf automake bash bash-completion bison build-base ccache cmake coreutils curl findutils flex git graphviz libarchive-tools libcap
          docker exec --env-file env.custom -w /root multiarch apk add libtool linux-headers ncurses-dev openssl-dev openssl-libs-static patch perl pkgconf python3 python3-dev re2c rsync rsync tar texinfo ttf-freefont xz zip

      - name: Docker - Git clone mtr
        run: docker exec --env-file env.custom -w /root multiarch git clone --single-branch --branch "master" --shallow-submodules --recurse-submodules --depth 1 https://github.com/traviscross/mtr /root/${{ matrix.name }}

      - name: Bootstrap ${{ matrix.name }}
        run: docker exec -w /root/${{ matrix.name }} multiarch ./bootstrap.sh

      - name: Docker - Configure ${{ matrix.name }}
        run: docker exec --env-file env.custom -w /root/${{ matrix.name }} multiarch ./configure --host=${{ matrix.docker_tag }} --prefix=/root CXXFLAGS="${{ env.CXXFLAGS }}" CPPFLAGS="${{ env.CPPFLAGS }}" LDFLAGS="${{ env.LDFLAGS }}"

      - name: Docker - Make Install Build ${{ matrix.name }}
        run: docker exec --env-file env.custom -w /root/${{ matrix.name }} multiarch make -j$(nproc) install

      - name: Docker - Rename ${{ matrix.name }} to ${{ matrix.docker_tag }}-${{ matrix.name }}
        run: docker exec --env-file env.custom multiarch mv -f /root/sbin/${{ matrix.name }} /root/sbin/${{ matrix.docker_tag }}-${{ matrix.name }}

      - name: Docker - Rename ${{ matrix.name }}-packet to ${{ matrix.docker_tag }}-${{ matrix.name }}-packet
        run: docker exec --env-file env.custom multiarch mv -f /root/sbin/${{ matrix.name }}-packet /root/sbin/${{ matrix.docker_tag }}-${{ matrix.name }}-packet

      - name: Host - Create path to binary env
        run: echo "binary_path=$(echo ${{ github.workspace }}/sbin/${{ matrix.docker_tag }}-${{ matrix.name }})" >> $GITHUB_ENV

      - name: Host - Create path to binary-packet env
        run: echo "binary_packet_path=$(echo ${{ github.workspace }}/sbin/${{ matrix.docker_tag }}-${{ matrix.name }}-packet)" >> $GITHUB_ENV

      - name: Host - Create release name env
        run: echo "binary_release_name=$(strings ${{ env.binary_path }} | sed -rn 's|^(mtr) ([0-9].*)|\1 \2|p' | head -n 1)" >> $GITHUB_ENV

      - name: Host - Create tag env
        run: echo "binary_tag=$(strings ${{ env.binary_path }} | sed -rn 's|^(mtr) ([0-9].*)|\2|p' | head -n 1)" >> $GITHUB_ENV

      - name: "Create release"
        uses: ncipollo/release-action@v1
        with:
          prerelease: false
          artifacts: "${{ env.binary_path }},${{ env.binary_packet_path }}"
          replacesArtifacts: true
          tag: "${{ env.binary_tag }}"
          name: "${{ env.binary_release_name }}"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
